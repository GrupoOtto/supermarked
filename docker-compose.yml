version: '3'

services:
  stock-api:
    build: ./stock
    restart: always
    environment: 
      DB_URL: 'mongodb://stock-db/stock'
    volumes: 
      - ./stock:/usr/src/app
      - /usr/src/app/node_modules
    depends_on:
      - stock-db

  stock-db:
    image: mongo
    restart: always
    volumes:
      - stock-data:/data/db

  employees-api:
    build: ./employees
    restart: always
    environment: 
      DB_URL: 'mongodb://employees-db/employees'
    volumes: 
      - ./employees:/usr/src/app
      - /usr/src/app/node_modules
    depends_on:
      - employees-db

  employees-db:
    image: mongo
    restart: always
    volumes:
      - employees-data:/data/db
  
  proxy:
    build: ./proxy
    environment: 
      - ACME_AGREE=true
    restart: always
    ports: 
      - 80:80
      - 433:433
    depends_on:
      - employees-api
      - stock-api

volumes:
  stock-data:
  employees-data: